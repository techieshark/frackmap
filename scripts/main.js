"use strict";!function(){function t(t){return t.frequency=+t.frequency,t.year=+t.year,t}var e=window.d3,r=function(t){this.container=t.container||"body",this.totalWidth=t.width||760,this.totalHeight=t.height||250,this.barBulgeEndCallback=t.barBulgeEndCallback||function(){},this.barEmptiedCallback=t.barEmptiedCallback||function(){},this.barMouseDownCallback=t.barMouseDownCallback||function(){},this.barMouseUpCallback=t.barMouseUpCallback||function(){};var r={top:20,right:20,bottom:30,left:40};this.margin=r,this.width=this.totalWidth-r.left-r.right,this.height=this.totalHeight-r.top-r.bottom,this.y=e.scale.linear().range([this.height,0]),this.yAxis=e.svg.axis().scale(this.y).orient("left"),this.render()};window.Chart=r,r.prototype.render=function(){this.svgContainer=e.select(this.container).append("svg").attr("class","chart").attr("width",this.totalWidth).attr("height",this.totalHeight),this.svg=this.svgContainer.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.buildChart()};var a=function(t){return""+t.year};r.prototype.bulgeBar=function(t,e){var r=250,a=this,n=this.x3.rangeBand(),i=this.getBarHeight(e),o=this.getBarTopY(e),s="\n                M 0,"+o+" "+n+","+o+"\n                C "+n+","+o+" "+n+","+(o+i)+" "+n+","+(o+i)+"\n                l -"+n+",0\n                C 0,"+(o+i)+" 0,"+o+" 0,"+o+"\n                Z",c=.25*n,l="\n                M 0,"+o+" "+n+","+o+"\n                C "+(n+c)+","+(o+.3*i)+" "+(n+c)+","+(o+.7*i)+" "+n+","+(o+i)+"\n                l -"+n+",0\n                C "+(0-c)+","+(o+.7*i)+" "+(0-c)+","+(o+.3*i)+" 0,"+o+"\n                Z";return t.append("path").attr("class","bulge").attr("d",s).transition().delay(0).duration(r).attr("d",l).each("end",function(){a.barBulgeEndCallback(e)}).transition().duration(r).ease("elastic").attr("d",s).remove()},r.prototype.buildChart=function(){var r=this.svg,n=this.y,i=this.yAxis,o=this.height,s=this.barMouseDownCallback,c=this.barMouseUpCallback,l=this.barEmptiedCallback,u=this;e.tsv("data/frack-data.tsv",t,function(t,d){if(t)throw t;u.data=d;var p=.2,h=.1,f=u.x3=e.scale.ordinal().domain(d.map(a)).rangeRoundBands([0,u.width],h,p),y=e.svg.axis().scale(f).orient("bottom");n.domain([0,e.max(d,function(t){return t.frequency})]),r.append("g").attr("class","x axis").attr("transform","translate(0,"+(o+2)+")").call(y),r.append("g").attr("class","y axis").call(i).append("text").attr("transform","rotate(-90)").attr("y",12).style("text-anchor","end").text("Frequency"),r.selectAll(".bar").data(d).enter().append("g").attr("transform",function(t){return"translate("+f(a(t))+",0)"}).attr("class","bar").on("mouseover",s).on("mousedown",s).on("mouseup",c);var g=r.selectAll(".bar"),v=function(t){return o-n(t.frequency)},b=function(t){return n(t.frequency)};g.append("rect").attr("width",f.rangeBand()).attr("y",o).attr("height",0).transition().duration(300).delay(function(t,e){return 1e3*e}).attr("y",b).attr("height",v).each("end",function(t){var r=e.select(this.parentNode);u.bulgeBar(r,t),r.transition().delay(400).attr("class","bar emptied").each("end",function(t){l(t)})}),g.append("text").text(function(t){return t.frequency}).attr("x",function(){var t=this.getBBox().width;return f.rangeBand()/2-t/2}).attr("y",function(t){var e=this.getBBox().height;return n(t.frequency)-e}).attr("dy",".75em")})},r.prototype.getBarTopY=function(t){return this.y(t.frequency)},r.prototype.getBarCenterX=function(t){return this.x3(t.year)+this.x3.rangeBand()/2},r.prototype.getBarHeight=function(t){return this.height-this.y(t.frequency)}}(),function(){function t(t){var e;return e=t.indexOf("://")>-1?t.split("/")[2]:t.split("/")[0],e=e.split(":")[0],e.indexOf("www.")>-1&&(e=e.split("www.")[1]),e}var e=window.mapboxgl,r=window.d3,a=window._,n=window.$,i=window.Chart;e.accessToken="pk.eyJ1IjoidGVjaGllc2hhcmsiLCJhIjoiY2lrcTUxZmJvMTkweHRubTZlOGt5MnZzeiJ9.CxxVSVIPSsgFFL3Dx-QTbA";var o=new e.Map({container:"map",style:"mapbox://styles/techieshark/cikw6xfu100d098kmu3ogo74t",center:[-94.5,35],zoom:3});window.mapboxMap=o,o.on("style.load",function(){var t="./data/Fracking_Calendar.geojson";r.json(t,function(e,r){if(e)return void console.error("Error acquiring map data source "+t+": "+e);r.features=r.features.map(function(t){return t.properties.year=new Date(t.properties["Full Date"]).getFullYear(),t}),o.addSource("locations",{type:"geojson",data:r}),o.addLayer({id:"points",interactive:!0,type:"circle",source:"locations",paint:{"circle-radius":5,"circle-color":"DarkSlateGray"}}),o.addLayer({id:"featuredBorder",type:"circle",source:"locations",paint:{"circle-radius":7,"circle-color":"red"}}),o.addLayer({id:"featured",type:"circle",source:"locations",paint:{"circle-radius":5,"circle-color":"black"}}),o.setFilter("points",["<","year",2e3]),o.setFilter("featured",["==","year",0]),o.setFilter("featuredBorder",["==","year",0]);var s,c=function(t){console.log("emptied bar for year "+t.year);var e=n(".stats .count");e.show();var i=parseInt(e[0].innerText);i+=t.frequency,e[0].innerText=i,o.setFilter("points",["<","year",t.year]);var c=a.filter(r.features,function(e){return e.properties.year===t.year}),l=a.map(c,function(t){var e=o.project(t.geometry.coordinates);return e.x=e.x-s.margin.left,e.y=e.y-s.margin.top-n(s.svgContainer[0][0]).offset().top,e}),u={x:s.getBarCenterX(t),y:s.getBarTopY(t)},d=s.svg.selectAll("circle.y-"+t.year).data(l).enter().append("circle"),p=1e3,h=0;d.attr("class","y-"+t.year).attr("cx",u.x).attr("cy",u.y).attr("r",5).transition().duration(p).ease("ease-out").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).each("start",function(){h++}).each("end",function(){0===--h&&(o.setFilter("featured",["==","year",t.year]),o.setFilter("featuredBorder",["==","year",t.year]),d.remove())})},l=function(t){o.setFilter("featured",["==","year",t.year]),o.setFilter("featuredBorder",["==","year",t.year])},u=function(){o.setFilter("featured",["==","year",0]),o.setFilter("featuredBorder",["==","year",0])};s=new i({barBulgeEndCallback:c,barMouseDownCallback:l,barMouseUpCallback:u})})});var s=new e.Popup;o.on("click",function(e){console.log("click event"),console.log(e),o.featuresAt(e.point,{radius:7,includeGeometry:!0,layer:"points"},function(e,r){if(e||!r.length)return e&&console.log("error: "+e),void s.remove();var a=r[0],n=new Date(a.properties["Full Date"]),i=n.getFullYear(),c=n.getDate(),l=a.properties.Month,u=c+" "+l+", "+i,d=a.properties["Source 1"];s.setLngLat(a.geometry.coordinates).setHTML('<div class="map-popup-title">'+a.properties["Incident Type"]+"</div><p>"+a.properties["Incident Description"]+'</p><div class="incident-date">'+u+'</div><div class="incident-location">'+a.properties.Location+", "+a.properties.State+'</div><div class="incident-source"><a href="'+d+'">'+t(d)+"</a></div>").addTo(o)})}),o.on("mousemove",function(t){o.featuresAt(t.point,{radius:7,layer:"points"},function(t,e){o.getCanvas().style.cursor=!t&&e.length?"pointer":""})})}();